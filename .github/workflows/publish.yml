name: Publish Release (Canary OR Stable)

on:
  # TRIGGER 1: Canary Builds
  push:
    branches:
      - main
      - canary
      - introduce-v2
  # TRIGGER 2: Stable Releases
  release:
    types:
      - published

permissions:
  contents: read
  id-token: write

jobs:
  build-and-pack:
    name: Build and Pack
    if: ${{ github.repository_owner == 'hashgraph'  }}
    runs-on: wallet-tools-linux-medium
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup NodeJS Environment
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20.x
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm
        run: npm install -g npm@11.6.4

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Set Canary Version
        if: ${{ github.event_name == 'push' }}
        run: |
          # For canary publishing - bump version to prerelease format: 1.0.0-canary.abc1234.0
          npm version prerelease --preid="canary.$(git rev-parse --short HEAD)" --no-git-tag-version

      - name: Pack Package
        id: pack
        run: |
          # Calculate expected package filename from package.json
          PACKAGE_NAME=$(node -p "require('./package.json').name.replace('@', '').replace('/', '-')")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          EXPECTED_FILENAME="${PACKAGE_NAME}-${PACKAGE_VERSION}.tgz"
          
          # Create the package
          npm pack
          
          # Verify the expected file exists
          if [ ! -f "$EXPECTED_FILENAME" ]; then
            echo "Error: Expected package file $EXPECTED_FILENAME not found"
            echo "Available files:"
            ls -la *.tgz
            exit 1
          fi
          
          echo "PACK_FILENAME=$EXPECTED_FILENAME" >> $GITHUB_OUTPUT

      - name: Upload Package Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: package-artifact
          path: ${{ steps.pack.outputs.PACK_FILENAME }}
          if-no-files-found: error

  publish-package:
    name: Publish to NPM
    needs: build-and-pack
    runs-on: ubuntu-latest # Must be GitHub-hosted for OIDC for npmjs
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Setup NodeJS Environment
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 20.x
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm
        run: npm install -g npm@11.6.4

      - name: Download Package Artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: package-artifact

      - name: Determine Publish Flags
        id: flags
        run: |
          # Default flags
          FLAGS="--access public"
          
          # If it is a Push event, add the canary tag
          if [[ "${{ github.event_name }}" == "push" ]]; then
            FLAGS="$FLAGS --tag canary"
          fi
          
          # If it is a Release, we assume 'latest' (which is default), so no extra flag needed.
          
          echo "args=$FLAGS" >> $GITHUB_OUTPUT

      - name: Publish
        run: |
          # Verify exactly one .tgz file exists
          TGZ_COUNT=$(ls -1 *.tgz 2>/dev/null | wc -l)
          if [ "$TGZ_COUNT" -ne 1 ]; then
            echo "Error: Expected exactly 1 .tgz file, found $TGZ_COUNT"
            ls -la *.tgz 2>/dev/null || echo "No .tgz files found"
            exit 1
          fi
          
          PACKAGE_FILE=$(ls *.tgz)
          echo "Publishing package: $PACKAGE_FILE"
          npm publish "$PACKAGE_FILE" ${{ steps.flags.outputs.args }}
